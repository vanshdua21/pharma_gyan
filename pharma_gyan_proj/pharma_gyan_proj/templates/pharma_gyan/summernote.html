<link rel="stylesheet" media="screen, print" href="/static/pharma_gyan/css/summernote.css">

<div id="main-form-div">
    <div class="row">
        <div class="col-xl-12">
             <div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-hdr">
				<h2>
					Enter the Chapter Content here
				</h2>
				<div class="panel-toolbar">
					<button class="btn btn-panel" data-action="panel-collapse" data-toggle="tooltip" data-offset="0,10" data-original-title="Collapse"></button>
					<button class="btn btn-panel" data-action="panel-fullscreen" data-toggle="tooltip" data-offset="0,10" data-original-title="Fullscreen"></button>
					<button class="btn btn-panel" data-action="panel-close" data-toggle="tooltip" data-offset="0,10" data-original-title="Close"></button>
				</div>
			</div>
			<div class="panel-container show">
				<div class="panel-content">
					<div class="js-summernote" id="saveToLocal"></div>
					<div class="mt-3">
						<button class="btn  btn-small btn-success" onclick="saveSummernoteData()" >Save</button>
					</div>

				</div>
			</div>
		</div>
	</div>
</div>
</div>


</div>
</div>
	<script src="/static/pharma_gyan/js/summernote.js"></script>
<script>
    var interval;

    // Save to local storage
    var saveToLocal = function() {
        localStorage.setItem('summernoteData', $('#saveToLocal').summernote("code"));
        console.log("Saved to local storage");
    };

    // Remove from local storage
    var removeFromLocal = function() {
        localStorage.removeItem("summernoteData");
        $('#saveToLocal').summernote('reset');
        console.log("Removed from local storage");
    };

    // Timer function for auto-save
    var timer = function() {
        interval = setInterval(function() {
            saveToLocal();
            clearInterval(interval);
        }, 3000);
    };

    // Function to handle image upload
    function uploadImages(files) {
        for (let i = 0; i < files.length; i++) {
            let file = files[i];

            // Check if filename is valid (only alphanumeric, underscores, dots, and dashes)
            if (!validateFilename(file.name)) {
                alert("Invalid filename: Only alphanumeric characters, underscores, dots, and dashes are allowed.");
                console.log("Invalid filename:", file.name);
                continue; // Skip uploading this file
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert("File size exceeds 5MB limit.");
                console.log("File size exceeds 5MB limit:", file.name);
                continue; // Skip uploading this file
            }

            let data = new FormData();
            data.append("image-file", file);

            $.ajax({
                url: 'addMedia/',  // Check this URL path
                cache: false,
                contentType: false,
                processData: false,
                data: data,
                type: "POST",
                success: function(response) {
                    if (response.result === 'success') {
                        let imgNode = $('<img>').attr('src', response.data.file_urls[0]);
                        $('.js-summernote').summernote('insertNode', imgNode[0]);

                        // Manage multiple URLs in localStorage
                        var uploadedImageURLs = JSON.parse(localStorage.getItem('uploadedImageURLs')) || [];
                        response.data.file_urls.forEach(url => {
                            uploadedImageURLs.push(url);
                        });
                        localStorage.setItem('uploadedImageURLs', JSON.stringify(uploadedImageURLs));
                    } else {
                        console.log("Image upload failed");
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log("Image upload failed:", textStatus, errorThrown);
                }
            });
        }
    }

    // Function to handle video upload
    function uploadVideos(files) {
        for (let i = 0; i < files.length; i++) {
            let file = files[i];

            // Check if filename is valid (only alphanumeric, underscores, dots, and dashes)
            if (!validateFilename(file.name)) {
                alert("Invalid filename: Only alphanumeric characters, underscores, dots, and dashes are allowed.");
                console.log("Invalid filename:", file.name);
                continue; // Skip uploading this file
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert("File size exceeds 5MB limit.");
                console.log("File size exceeds 5MB limit:", file.name);
                continue; // Skip uploading this file
            }

            let data = new FormData();
            data.append("video-file", file);

            $.ajax({
                url: 'addMedia/',  // Check this URL path
                cache: false,
                contentType: false,
                processData: false,
                data: data,
                type: "POST",
                success: function(response) {
                    if (response.result === 'success') {
                        let videoNode = $('<video controls>').attr('src', response.data.file_urls[0]);
                        $('.js-summernote').summernote('insertNode', videoNode[0]);

                        // Manage multiple URLs in localStorage
                        var uploadedVideoURLs = JSON.parse(localStorage.getItem('uploadedVideoURLs')) || [];
                        response.data.file_urls.forEach(url => {
                            uploadedVideoURLs.push(url);
                        });
                        localStorage.setItem('uploadedVideoURLs', JSON.stringify(uploadedVideoURLs));
                    } else {
                        console.log("Video upload failed");
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log("Video upload failed:", textStatus, errorThrown);
                }
            });
        }
    }

    // Function to save Summernote data via AJAX
    function saveSummernoteData() {
        var data = $('#saveToLocal').summernote("code");
        $.ajax({
            type: 'POST',
            url: 'saveSummernote/',
            data: {'data': data},
            success: function() {
                console.log("Save Success");
            },
            error: function() {
                console.log("Save Failed");
            }
        });
    }

    // Validate filename (only alphanumeric, underscores, dots, and dashes allowed)
    function validateFilename(filename) {
        return /^[a-zA-Z0-9_.-]*$/.test(filename);
    }

    $(document).ready(function () {
        // Custom video button
        var videoButton = function (context) {
            var ui = $.summernote.ui;

            // create button
            var button = ui.button({
                contents: '<i class="note-icon-video"/>',
                tooltip: 'Upload Video',
                click: function () {
                    var fileInput = $('<input type="file" accept="video/*" multiple>');
                    fileInput.trigger('click');

                    fileInput.on('change', function() {
                        var files = this.files;
                        uploadVideos(files);
                    });
                }
            });

            return button.render();   // return button as jquery object
        };

        // Initialize Summernote
        $('.js-summernote').summernote({
            height: 500,
            tabsize: 2,
            placeholder: "Type here...",
            dialogsFade: true,
            toolbar: [
                ['style', ['style']],
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['font', ['bold', 'italic', 'underline', 'clear']],
                ['fontsize', ['fontsize']],
                ['fontname', ['fontname']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['height', ['height']],
                ['table', ['table']],
                ['insert', ['picture', 'videoUpload']], // Add the custom button here
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            buttons: {
                videoUpload: videoButton  // Define the custom button
            },
            callbacks: {
                onImageUpload: function(files) {
                    uploadImages(files);
                },
                onMediaDelete: function(target) {
                    deleteMedia(target[0].src);  // Define deleteMedia function as needed
                },
                onChange: function(contents, $editable) {
                    clearInterval(interval);
                    timer();
                }
            }
        });

        // Attach event listener for the custom button to upload media
        document.querySelector("#panel-1 .note-editor .modal-footer input").addEventListener('click', function() {
            let input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = 'image/*,video/*'; // Allow both images and videos
            input.onchange = function(event) {
                let files = event.target.files;
                let imageFiles = [];
                let videoFiles = [];

                for (let i = 0; i < files.length; i++) {
                    if (files[i].type.startsWith('image/')) {
                        imageFiles.push(files[i]);
                    } else if (files[i].type.startsWith('video/')) {
                        videoFiles.push(files[i]);
                    }
                }

                if (imageFiles.length > 0) {
                    uploadImages(imageFiles);
                }

                if (videoFiles.length > 0) {
                    uploadVideos(videoFiles);
                }
            };
            input.click();
        });
    });

</script>




