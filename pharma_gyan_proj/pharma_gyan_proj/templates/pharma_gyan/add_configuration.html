<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Add configuration</title>
    <style type="text/css"></style>
    <link
      rel="stylesheet"
      type="text/css"
      href="/static/pharma_gyan/css/jsoneditor.css"
    />
    <script src="/static/pharma_gyan/js/jsoneditor.js"></script>
    <link
      rel="stylesheet"
      media="screen, print"
      href="/static/pharma_gyan/css/select2.bundle.css"
    />
  </head>
  <body>
    <div id="main-form-div">
      <div class="row">
        <div class="col-xl-12">
          <div class="panel" id="bankConfigurationPanel">
            <div class="panel-hdr">
              <h2>
                <span class="fw-900"><i>Bank configuration</i></span>
              </h2>
              <div class="panel-toolbar">
                <button
                  class="btn btn-panel"
                  data-action="panel-collapse"
                  data-toggle="tooltip"
                  data-offset="0,10"
                  data-original-title="Collapse"
                ></button>
                <button
                  class="btn btn-panel"
                  data-action="panel-fullscreen"
                  data-toggle="tooltip"
                  data-offset="0,10"
                  data-original-title="Fullscreen"
                ></button>
                <button
                  class="btn btn-panel"
                  data-action="panel-close"
                  data-toggle="tooltip"
                  data-offset="0,10"
                  data-original-title="Close"
                ></button>
              </div>
            </div>
            <div class="panel-container">
              <div class="form-group row m-3">
                <div class="col-4">
                  <label for="bankName">Bank name</label>
                  <select
                    class="form-control select2"
                    id="bankName"
                    name="bankName"
                    data-placeholder="Select Bank name"
                    required
                  ></select>
                </div>
                <div class="col-4" style="display: none">
                  <label for="environment">Environment</label>
                  <select
                    class="form-control select2"
                    id="environment"
                    name="environment"
                    data-placeholder="Select Environment"
                    required
                  ></select>
                </div>
                <div class="col-4" style="display: none">
                  <label for="project">Project</label>
                  <select
                    class="form-control select2"
                    id="project"
                    name="project"
                    data-placeholder="Select Project"
                    required
                  ></select>
                </div>
              </div>
            </div>
          </div>
          <div id="panel-1" class="panel">
            <div class="panel-hdr">
              <h2>
                Add<span class="fw-900"><i>configuration</i></span>
              </h2>
              <div class="panel-toolbar">
                <button
                  class="btn btn-panel"
                  data-action="panel-collapse"
                  data-toggle="tooltip"
                  data-offset="0,10"
                  data-original-title="Collapse"
                ></button>
                <button
                  class="btn btn-panel"
                  data-action="panel-fullscreen"
                  data-toggle="tooltip"
                  data-offset="0,10"
                  data-original-title="Fullscreen"
                ></button>
                <button
                  class="btn btn-panel"
                  data-action="panel-close"
                  data-toggle="tooltip"
                  data-offset="0,10"
                  data-original-title="Close"
                ></button>
              </div>
            </div>
            <div class="panel-container" style="min-height: 60vh">
              <div id="divLoader" style="display: none">
                <div
                  class="position-absolute d-flex flex-column justify-content-center align-items-center h-100 w-100"
                  style="z-index: 2; background-color: rgba(255, 255, 255, 0.7)"
                >
                  <div class="spinner-border mb-2" role="status"></div>
                  <div style="font-size: 16px">Loading...</div>
                </div>
              </div>
              <div id="splashScreen" style="">
                <div
                  class="position-absolute d-flex flex-column justify-content-center align-items-center h-100 w-100"
                  style="z-index: 2; background-color: rgba(255, 255, 255, 0.9)"
                >
                  <div style="font-size: 26px">
                    Please Select Bank Configurations first.
                  </div>
                </div>
              </div>

              <div id="congratsConfigSaved" style="display: none">
                <div
                  class="position-absolute d-flex flex-column justify-content-center align-items-center h-100 w-100"
                  style="z-index: 2; background-color: rgba(255, 255, 255, 1)"
                >
                  <div
                    class="h-100 d-flex justify-content-center align-items-center"
                  >
                    <div
                      class="panel p-6 d-flex flex-column justify-content-center align-items-center text-center"
                      style="font-size: 20px"
                    >
                      <img
                        src="/static/pharma_gyan/img/accepted.png"
                        class="img-fluid mb-5"
                        width="75"
                        height="75"
                      />
                      <span class="mx-2 mb-5"
                        >Congratulations,Your configuration has been saved
                        successfully!</span
                      >
                      <a
                        href="#manageConfigurations"
                        class="btn btn-lg btn-outline-info waves-effect waves-themed"
                        ><i class="fal fa-eye"></i
                        ><span class="ml-2">View Configurations</span></a
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <form id="" class="p-4" onsubmit="createConfig(event)">
                  <div class="d-flex justify-content-between mb-3">
                    <div class="form-group w-50">
                      <label class="form-label" for="">Config key</label>
                      <input
                        type="text"
                        id="configKey"
                        class="form-control"
                        name="key"
                        pattern="^[a-zA-Z0-9_]*$"
                        placeholder="Enter Config key"
                        required
                      />
                    </div>
                    <div class="w-25" style="">
                      <label class="form-label" for="versionDropdown"
                        >Versions
                      </label>
                      <select
                        class="form-control select2"
                        id="versionDropdown"
                        style="width: 25% !important"
                        data-placeholder="Select version"
                      ></select>
                      <div
                        class="my-2"
                        style="
                          display: flex;
                          font-size: 14px;
                          justify-content: space-between;
                          align-items: center;
                        "
                      >
                        <div>
                          <label class="form-label">Active version : </label>
                          <b id="activeVersion">NA</b>
                        </div>
                        <button
                          id="makeActiveBtn"
                          type="button"
                          value=""
                          class="btn btn-outline-danger waves-effect waves-themed btn-outline-danger"
                          onclick="makeVersionActive()"
                        >
                          Make active
                        </button>
                      </div>
                    </div>
                  </div>

                  <div
                    class="d-flex"
                    style="min-height: 400px; margin-bottom: 20px"
                  >
                    <div style="width: 45%">
                      <div id="jsonraw">
                        <div style="text-align: center">
                          <h4 style="font-weight: bold">Raw JSON</h4>
                        </div>
                        <div id="raw">
                          <textarea
                            id="raw-json-data"
                            name="conf_value"
                            style="
                              height: 355px;
                              width: 100%;
                              border-color: #b19dce;
                            "
                            required
                          ></textarea>
                        </div>
                      </div>
                    </div>
                    <div
                      id="splitter"
                      style="
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        width: 10%;
                      "
                    >
                      <span
                        style="
                          align-self: center;
                          font-size: 14px;
                          font-weight: bold;
                        "
                        >Text to JSON</span
                      >
                      <button
                        type="button"
                        id="toForm"
                        title="JSON to Editor"
                        class="btn btn-primary btn-lg mx-3 waves-effect waves-themed"
                        onclick="jsonToEditor();"
                      >
                        <i class="fal fa-arrow-alt-right"></i>
                      </button>
                      <span
                        style="
                          margin-top: 30px;
                          align-self: center;
                          font-size: 14px;
                          font-weight: bold;
                        "
                        >JSON to Text</span
                      >
                      <button
                        type="button"
                        id="toJSON"
                        title="Editor to JSON"
                        class="btn btn-primary btn-lg mx-3 waves-effect waves-themed"
                        onclick="editorToJson()"
                      >
                        <i class="fal fa-arrow-alt-left"></i>
                      </button>
                    </div>
                    <div style="width: 45%">
                      <div style="text-align: center">
                        <h4 style="font-weight: bold">Foramtted JSON</h4>
                      </div>
                      <div id="jsoneditor" style="height: 355px"></div>
                    </div>
                  </div>
                  <div
                    id="issues"
                    class="alert alert-danger"
                    role="alert"
                    style="margin-top: 20px; display: none"
                  >
                    <strong>Oh snap!</strong> Change a few things up and try
                    submitting again.
                    <ul id="issue-items" style="margin-top: 10px"></ul>
                  </div>
                  <div class="">
                    <button
                      type="submit"
                      class="btn btn-primary btn-lg waves-effect waves-themed"
                    >
                      Save Configuration
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal -->
    <div
      class="modal fade example-modal-centered-transparent show"
      id="tryAgainModal"
      tabindex="-1"
      role="dialog"
      style="display: none; padding-right: 15px"
      aria-modal="true"
    >
      <div
        class="modal-dialog modal-dialog-centered modal-transparent"
        role="document"
      >
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close text-white"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true"><i class="fal fa-times"></i></span>
            </button>
          </div>
          <h2 class="modal-body text-center text-white">
            Something Went Wrong, Please try again
          </h2>
          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn btn-primary waves-effect waves-themed"
              onclick="location.reload();"
            >
              Try again
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="toast hide"
      style="position: absolute; top: 50%; right: 40%"
      id="toast"
      data-delay="2000"
    >
      <div class="toast-header">
        <strong class="mr-auto" id="toastInfo"></strong>
        <button
          type="button"
          class="ml-2 mb-1 close"
          data-dismiss="toast"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div
      class="toast hide"
      style="
        position: absolute;
        top: 50%;
        right: 45%;
        background-color: rgb(220 53 69);
        color: white;
        min-width: 250px;
      "
      id="somethingWentWrongAlert"
      data-delay="2000"
    >
      <div class="toast-header">
        <strong class="mr-auto">Alert</strong>
        <button
          type="button"
          class="ml-2 mb-1 close"
          data-dismiss="toast"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="toast-body">Somthing went wrong, Please try again.</div>
      <!-- <div class="toast-header">
      <strong class="mr-auto" id="toastInfo">lmcklwkmeck</strong>
    </div> -->
    </div>
  </body>
  <script type="text/javascript">
    var jsonContainer = document.getElementById("jsoneditor");
    var editor = new JSONEditor(jsonContainer);
    var currentUser = "{{ user }}";
    var conf_key = "{{ conf_key }}";
    var conf_version = "{{ conf_version }}";
    var mode = "{{mode}}";
    var bankFromURL = "{{ bank }}";
    var envFromURL = "{{ env }}";
    var projectFromURL = "{{ project }}";
    var currentEnvironment = envFromURL || "";
    var currentProject = projectFromURL || "";
    var currentBank = bankFromURL || "";
    var user_bank_settings={{user_bank_settings|safe}};
    var apiBasePath = "";

    $(document).ready(function () {
      $(".select2").select2();
      if (bankFromURL && envFromURL && projectFromURL) {
        apiBasePath =
          user_bank_settings?.[bankFromURL]?.[envFromURL]?.[projectFromURL]
            ?.url || "";
      }
      if (
        !conf_key ||
        !conf_version ||
        !mode ||
        !bankFromURL ||
        !envFromURL ||
        !projectFromURL ||
        !apiBasePath
      ) {
        mode = "create";
      }
      handleMode(mode);
    });

    $("#bankName").on("change", function () {
      currentBank = this.value;
      $("#environment").parent().show();
      var environmentOptionsHtml =
        "<option value='' disabled selected></option>";
      for (const environment of Object.keys(user_bank_settings[this.value])) {
        environmentOptionsHtml += `<option value='${environment}'>${environment}</option>`;
      }
      $("#environment").html(environmentOptionsHtml);
      $("#project").parent().hide();
      $("#project").html("");
    });
    $("#environment").on("change", function () {
      currentEnvironment = this.value;
      $("#project").parent().show();
      const bank = $("#bankName").val();
      var projectOptionsHtml = "<option value='' disabled selected></option>";
      for (const project of Object.keys(user_bank_settings[bank][this.value])) {
        projectOptionsHtml += `<option value='${project}'>${project}</option>`;
      }
      $("#project").html(projectOptionsHtml);
    });
    $("#project").on("change", function () {
      currentProject = this.value;
      const bank = $("#bankName").val();
      const env = $("#environment").val();
      apiBasePath = user_bank_settings?.[bank]?.[env]?.[this.value]?.url;
      if (!!this.value) {
        $("#splashScreen").hide();
      }
    });
    $(document).on("change", "#bankName, #environment, #project", function () {
      $("#bankName, #environment, #project").map(function () {
        if (!this.value) {
          $("#splashScreen").show();
        }
      });
    });
    function handleMode(mode) {
      if (mode === "create") {
        var bankNameOptionsHtml =
          "<option value='' disabled selected></option>";
        for (const bank of Object.keys(user_bank_settings)) {
          bankNameOptionsHtml += `<option value='${bank}'>${bank}</option>`;
        }
        $("#bankName").html(bankNameOptionsHtml);
      } else if (mode == "view" || mode == "edit") {
        $("#bankConfigurationPanel").hide();
        $("#splashScreen").hide();
        $("#configKey").attr("readonly", true);
        if (mode == "view") {
          $("#raw-json-data").attr("readonly", true);
        } else if (mode == "edit") {
          $("#raw-json-data").attr("readonly", false);
        }
        if (!!apiBasePath) {
          getConfFromKey(conf_version, conf_key);
        }
      }
    }
    function getConfFromKey(version, key) {
      $("#divLoader").show();
      const postParamsData = {};
      if (
        user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
          currentProject
        ]?.url_params?.post &&
        Array.isArray(
          user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
            currentProject
          ]?.url_params?.post
        )
      ) {
        user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
          currentProject
        ]?.url_params?.post.forEach((el) => {
          postParamsData[el.key] = el.value;
        });
      }
      $.ajax({
        url: apiBasePath + "/api/cms/v1/get_config_from_key/",
        // url: "http://demo5867723.mockable.io/get_config_from_key  ",
        type: "POST",
        data: JSON.stringify({ ...postParamsData, key: key, version: version }),
        contentType: "application/json",
        success: function (response) {
          console.log("response", response);
          $("#divLoader").hide();
          if (response?.success) {
            handleConfigData(response?.data);
          } else {
            $("#somethingWentWrongAlert").toast("show");
          }
        },
        error: function (error) {
          $("#divLoader").hide();
          $("#somethingWentWrongAlert").toast("show");
        },
      });
    }
    function handleConfigData(data) {
      $("#configKey").val(data?.conf_key);
      $("#raw-json-data").val(data?.conf_val);
      var versionDropdownHtml = "<option value='' disabled ></option>";
      for (var el of data?.conf_meta) {
        versionDropdownHtml += `<option value='${el?.version}' ${
          el?.version === data?.version ? "selected='selected'" : ""
        } >Version ${el?.version}, Created by ${el?.user}</option>`;
        if (!!el?.active) {
          $("#activeVersion").html(el?.version);
        }
      }
      if (!!data?.active) {
        $("#makeActiveBtn").prop("disabled", true);
      } else {
        $("#makeActiveBtn").prop("disabled", false);
        $("#makeActiveBtn").val(data?.uid);
      }
      $("#versionDropdown").html(versionDropdownHtml);
    }
    $("#versionDropdown").change(function () {
      getConfFromKey(this.value, conf_key);
    });
    function makeVersionActive() {
      var data = { uid: $("#makeActiveBtn").val(), active: true };
      $("#divLoader").show();
      const postParamsData = {};
      if (
        user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
          currentProject
        ]?.url_params?.post &&
        Array.isArray(
          user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
            currentProject
          ]?.url_params?.post
        )
      ) {
        user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
          currentProject
        ]?.url_params?.post.forEach((el) => {
          postParamsData[el.key] = el.value;
        });
      }
      if (!!apiBasePath) {
        $.ajax({
          url: apiBasePath + "/api/cms/v1/create_update_config/",
          type: "POST",
          data: JSON.stringify({ ...data, ...postParamsData }),
          contentType: "application/json",
          success: function (response) {
            $("#divLoader").hide();
            if (response?.success) {
              // $("#congratsConfigSaved").show();
              getConfFromKey($("#versionDropdown").val(), conf_key);
            } else {
              $("#somethingWentWrongAlert").toast("show");
            }
          },
          error: function (error) {
            $("#divLoader").hide();
            $("#somethingWentWrongAlert").toast("show");
          },
        });
      }
    }
    function createConfigApiCall(data) {
      $("#divLoader").show();
      if (!!apiBasePath) {
        const postParamsData = {};
        if (
          user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
            currentProject
          ]?.url_params?.post &&
          Array.isArray(
            user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
              currentProject
            ]?.url_params?.post
          )
        ) {
          user_bank_settings?.[currentBank]?.[currentEnvironment]?.[
            currentProject
          ]?.url_params?.post.forEach((el) => {
            postParamsData[el.key] = el.value;
          });
        }
        $.ajax({
          url: apiBasePath + "/api/cms/v1/create_update_config/",
          type: "POST",
          data: JSON.stringify({ ...data, ...postParamsData }),
          contentType: "application/json",
          success: function (response) {
            $("#divLoader").hide();
            if (response?.success) {
              $("#congratsConfigSaved").show();
            } else {
              $("#somethingWentWrongAlert").toast("show");
            }
          },
          error: function (error) {
            $("#divLoader").hide();
            $("#somethingWentWrongAlert").toast("show");
          },
        });
      }
    }

    function createConfig(event) {
      event.preventDefault();
      const myFormData = new FormData(event.target);
      const formDataObj = {};
      myFormData.forEach((value, key) => {
        formDataObj[key] = value;
      });
      formDataObj.user = currentUser;
      formDataObj.diff_meta = '{"test":"123"}';
      if (IsJson(formDataObj?.conf_value)) {
        createConfigApiCall(formDataObj);
      } else {
        alert("Invalid raw json! please correct it!");
      }
    }
    function jsonToEditor() {
      var json = $("#raw-json-data").val();
      if (IsJson(json) == true) editor.set(jQuery.parseJSON(json));
      else alert("Invalid raw json! please correct it!");
    }
    function editorToJson() {
      var json = editor.get();
      $("#raw-json-data").val(JSON.stringify(json, null, 2));
    }
    function IsJson(str) {
      try {
        JSON.parse(str);
      } catch (e) {
        return false;
      }
      return true;
    }
  </script>
</html>
