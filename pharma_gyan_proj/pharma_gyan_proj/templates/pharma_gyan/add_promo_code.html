<style type="text/css">
    .form-field-custom{
        font-weight:bold;
        font-size:14px;
    }

    body{
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
    }

    .form-group{
        display: flex;
        align-items: center;
    }

    .form-label{
        width: 15%
    }

    .permissionWrapper{
        margin: 15px 0;
    }

    .perHead{
        font-size: 18px;
        padding: 10px 0;
    }

    #perm{
        padding: 10px 40px;
        display: flex;
        flex-wrap: wrap;
    }
    #perm >div{
        width: 50%;
        padding: 8px;
    }
     .required:after {
    content:" *";
    color: red;
  }

</style>

<div id="success-div" style="margin-top: 20px; padding: 10px;display: none;"><div id="err-info" class="alert alert-success" style="padding: 30px;font-size: 18px;
"><strong>Congratulations!</strong> <span id="success-text"></span>

    </div>
    <button class="btn-outline-success btn-sm mr-1" onclick=redirectToAddPC()>Add Another Promo Code</button>
    <button class="btn-outline-success btn-sm mr-1" onclick=redirectToViewPC()>View Promo Codes</button></div>

<div id="main-form-div">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel">
                <div class="panel-hdr">
                    <h2 id="main_title">
                        Add Promo Code
                    </h2>
                    <div class="panel-toolbar">
                        <button class="btn btn-panel" data-action="panel-collapse" data-toggle="tooltip" data-offset="0,10" data-original-title="Collapse"></button>
                        <button class="btn btn-panel" data-action="panel-fullscreen" data-toggle="tooltip" data-offset="0,10" data-original-title="Fullscreen"></button>
                        <button class="btn btn-panel" data-action="panel-close" data-toggle="tooltip" data-offset="0,10" data-original-title="Close"></button>
                    </div>
                </div>
                <div class="panel-container show">
                    <div class="panel-content">


                        <div class="col-lg-9">
                            <div class="p-20">
                                <div action="#">


                                    <div class="form-group">
                                        <label class="form-label required" for="title">Title</label>
                                        <input type="text" id="title" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label required">Promo Code </label>
                                        <input type="text" id="promoCode" class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label required" style="padding-right: 20px;">Discount Type</label>
                                        <select class="form-control select2" id="discountType" onchange="typeChanged()">
                                        <option value="" disabled selected class="select2">Choose the discount type</option>
                                        <option value="flat" class="select2">Flat</option>
                                        <option value="percentage"class="select2">Percentage</option>
                                        </select>
                                    </div>

                                    <div class="form-group" id="discount-div">
                                        <label class="form-label required" for="discount">Discount (%)</label>
                                        <input type="text" id="discount" class="form-control">
                                    </div>

                                    <div class="form-group" id="maxDiscount-div">
                                        <label class="form-label" for="maxDiscount">Max Discount (Rs)</label>
                                        <input type="text" id="maxDiscount" class="form-control">
                                    </div>
                                    <div class="form-group" id="maxUsage-div">
                                        <label class="form-label" for="maxUsage">Max Usage</label>
                                        <input type="text" id="maxUsage" class="form-control">
                                    </div>

                                    <div class="form-group" id="expiryDate-div">
                                        <label class="form-label required" for="expiryDate">Expiry Date</label>
                                        <input type="date" id="expiryDate" class="form-control">
                                    </div>

                                    <div style="display: flex; padding-bottom: 30px";>
<!--                                    <div class="custom-control custom-checkbox col-lg-5"  id="isPublic-div">-->
<!--                                        <input type="checkbox" class="custom-control-input" id="isPublic" value="0">-->
<!--                                        <label class="custom-control-label" for="isPublic" style="font-size: 15px;padding-left: 15px">Is Public</label>-->
<!--                                    </div>-->
                                    <div class="custom-control custom-checkbox col-lg-5"  id="multiUsage-div">
                                        <input type="checkbox" class="custom-control-input" id="multiUsage" value="0">
                                        <label class="custom-control-label" for="multiUsage" style="font-size: 15px;padding-left: 15px">Multi Usage</label>
                                    </div>
                                        </div>

                                    <div class="addPromoCode">
                                        <button class="btn  btn-small btn-success" onclick="addPromoCode()" >Save</button>
<!--                                        <button class="btn  btn-small btn-danger" onclick="window.history.back()" style="margin-left: 8px" >Cancel</button>-->
                                    </div>





                                </div>
                            </div>
                        </div>



                    </div>
                    <div id="err-div" style="display: none;margin-top:20px;"></div>



                    <div id="progress-bar-div" style="margin-top:20px;margin-bottom:20px;width:100%;display:none;" class="progress progress-striped active">
                        <div id="progress-bar" class="progress-bar bg-success-500 bg-danger-gradient" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: 50%;">

                        </div>
                    </div>








                </div>
            </div>
        </div>
    </div>
</div>





<script type="text/javascript">

    var baseUrl = "{{ baseUrl }}";
    var mode = "{{mode}}";
    var currentCustomerData = {};

    $("#discount-div").hide();
    $("#multiUsage-div").hide();
    $("#maxUsage-div").hide();
    $("#maxDiscount-div").hide();
    $("#expiryDate-div").hide();

    $(document).ready(function() {

        function initProgressBar() {
            document.getElementById("progress-bar").style.width = '20%';
            $("#progress-bar-div").show();

        }

        function incBar() {
            var currWidth = $("#progress-bar").width();
            $("#progress-bar").width(currWidth + 50);
        }

        if(mode=="edit"){
            var currentCustomerData = JSON.parse('{{ promoCode|escapejs }}');
            console.log('Data-',currentCustomerData);
            setEditMode(currentCustomerData);

        }
         $("#multiUsage").change(function() {
            if ($(this).is(':checked')) {
                $("#maxUsage-div").show();
            } else {
                $("#maxUsage-div").hide();
            }
        });

    });

    function redirectToAddPC(){
        location.reload();
    }

    function redirectToViewPC(){
        window.location='#viewPromoCode';
    }
    function formatDateForInput(dateString) {

        let parts = dateString.split(/[\s,]+/); // Split by space or comma
        let day = parts[0].padStart(2, '0');
        let month = parts[1];
        let year = parts[2];


        let monthNumber = new Date(Date.parse(month + " 1, 2000")).getMonth() + 1; // Add 1 because getMonth() returns 0-11
        monthNumber = monthNumber.toString().padStart(2, '0');

        return `${year}-${monthNumber}-${day}`;
    }
    function setEditMode(customerData){
       $("#main_title").html('Edit Promo Code');

        $("#title").val(customerData["title"]);
        $("#discountType").val(customerData["discount_type"]);
        $("#promoCode").val(customerData["promo_code"]);

        const formattedDate = formatDateForInput(customerData["expiry_date"]);
        console.log('Formatted Date:', formattedDate);

        let expiryDateInput = $("#expiryDate");
        console.log('Expiry Date Input:', expiryDateInput);
        expiryDateInput.val(formattedDate);
        console.log('Expiry Date Input Value:', expiryDateInput.val());

    if (customerData["discount_type"] === "percentage") {
        $("#discount").val(customerData["discount"]);
        $("#maxDiscount").val(customerData["max_discount"]);
<!--        $("#maxUsage").val(customerData["max_usage"]);-->
        $("#discount").text("Discount (%)");
        $("#maxDiscount-div").show();
    } else {
        $("#discount").val(customerData["discount"]);
<!--        $("#maxUsage").val(customerData["max_usage"]);-->
        $("#discount").text("Discount (Rs)");
        $("#maxDiscount-div").hide();
    }
    $("#maxUsage").val(customerData["max_usage"]);


 if (customerData["multi_usage"]) {
        $("#multiUsage").attr("checked", true);
        $("#maxUsage-div").show();
    } else {
        $("#multiUsage").attr("checked", false);
        $("#maxUsage-div").hide();
    }

    $("#discount-div").show();
    $("#maxUsage-div").show();
    $("#expiryDate-div").show();
<!--    $("#isPublic-div").show();-->
<!--    $("#multiUsage-div").show();-->

    editUniqueId = customerData["unique_id"];
    editId = customerData["id"];
    }

    function setError(domId,msg){
        $("#"+domId+"-error").html(msg);
        $("#"+domId+"-err-icon").html('<i class="glyphicon glyphicon-remove-circle"></i>');
        $("#"+domId+"-group").addClass('has-error');
    }

    function setSuccess(domId){
        $("#"+domId+"-err-icon").html('<i class="fa fa-check"></i>');

        $("#"+domId+"-group").removeClass('has-error');
        $("#"+domId+"-group").addClass('has-success');
    }

    function initProgressBar()
    {

        document.getElementById("progress-bar").style.width='20%';
        $("#progress-bar-div").show();

    }

    function incBar()
    {
        var currWidth = $("#progress-bar").width();
        $("#progress-bar").width(currWidth+50);
    }


function typeChanged() {
    let discountType = $("#discountType").val();

    // Reset the multiUsage checkbox and hide maxUsage-div initially
    $("#multiUsage").prop('checked', false);
    $("#maxUsage-div").hide();

    if (discountType == "percentage") {
        $("#discount").text("Discount (%)");
        $("#maxDiscount-div").show();
    } else {
        $("#discount").text("Discount (Rs)");
        $("#maxDiscount-div").hide();
    }

    $("#discount-div").show();
    $("#expiryDate-div").show();
    $("#isPublic-div").show();
    $("#multiUsage-div").show();

    // Show maxUsage-div only if multiUsage is checked
    $("#multiUsage").change(function() {
        if ($(this).is(':checked')) {
            $("#maxUsage-div").show();
        } else {
            $("#maxUsage-div").hide();
        }
    });
}


    var lock = false;
    function addPromoCode(){
        if(!($('#title').val())){
            setError("title");
            $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">Please fill title ! </span></div>');
            $("#err-div").show();

            return;
        }

        setSuccess("title");

        if(!($('#promoCode').val())){
            setError("promoCode");
            $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">Please fill Promo Code ! </span></div>');
            $("#err-div").show();

            return;
        }
        setSuccess("promoCode");

        if(!($('#discountType').val())){
            setError("discountType");
            $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">Please select Discount Type ! </span></div>');
            $("#err-div").show();

            return;
        }

        setSuccess("discountType");

        if(!($('#discount').val())){
            setError("discount");
            $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">Please fill Display Discount ! </span></div>');
            $("#err-div").show();

            return;
        }

        setSuccess("discount");


        if(!($('#maxDiscount').val())){
            var maxDiscount = 0;
        }
        else{
        var maxDiscount = $('#maxDiscount').val();
        }

        setSuccess("maxDiscount");

        if(!($('#maxUsage').val())){
            var maxUsage = 0;
        }
        else{
        var maxUsage = $('#maxUsage').val();
        }
        setSuccess("maxUsage");

        if(!($('#expiryDate').val())){
            setError("expiryDate");
            $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">Please fill Display Expiry Date ! </span></div>');
            $("#err-div").show();

            return;
        }

        setSuccess("expiryDate");



        if ($('#multiUsage').is(':checked')) {
            multiUsage = 1;
        } else {
            multiUsage = 0;
        }
        setSuccess("multiUsage");

        lock = true;

        initProgressBar();

        $("#err-div").html('');
        var barInterval = setInterval('incBar()',25);
        let data = {'title':($('#title').val()),'promo_code':($('#promoCode').val()),'discount_type':($('#discountType').val()), 'discount':($('#discount').val()),'max_discount':maxDiscount,'max_usage':maxUsage, 'expiry_date': ($('#expiryDate').val()), 'multi_usage': multiUsage};
        console.log(data);
        if(mode=="edit"){
            data['unique_id'] = editUniqueId;
            data['id'] = editId;
        }
        $.ajax({
            type : 'POST',
            url : 'upsertPromoCode/',
            data : JSON.stringify(data),
            success :function(data)
            {
                lock=false;
                clearInterval(barInterval);
                $("#progress-bar").css({"width":"100%"});

                console.log('Success-->', data);
                if(data['result']=='SUCCESS')
                {
                    $("#success-div").show();
                    if(mode == "edit"){
                        $("#success-text").html("Promo Code edited Successfully");
                    }else{
                        $("#success-text").html("Promo Code added Successfully");
                    }

                    $("#main-form-div").hide();
                    return;
                }

                else
                {
                    $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">'+result['info']+'</span></div>');
                    $("#err-div").show();
                    $("#progress-bar-div").hide();

                    return;
                }


            },
            error : function(data)
            {
                lock=false;
                clearInterval(barInterval);
                console.log('AJAX call failed:', data);
                console.log('debugging',data.responseJSON);
                var message = data.responseJSON ? data.responseJSON['details_message'] : 'some error occured while saving, please contact administrator !';
                $("#err-div").html('<div id="err-info" class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error!</strong> <span id="err-text">'+message+'</span></div>');
                $("#err-div").show();
                $("#progress-bar-div").hide();

                return;
            }

        });



    }

    function validateEmail(email) {
        // http://stackoverflow.com/a/46181/11236

        var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    }
 SingleSelection.prototype.render = function () {
    var $selection = SingleSelection.__super__.render.call(this);

    $selection.addClass('select2-selection--single');

    $selection.html(
      '<span class="select2-selection__rendered"></span>' +
      '<span class="select2-selection__arrow" role="presentation">' +
        '<b role="presentation"></b>' +
      '</span>'
    );

    return $selection;
  };

</script>


